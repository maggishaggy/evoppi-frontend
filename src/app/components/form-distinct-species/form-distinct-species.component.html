<!--
  ~  EvoPPI Frontend
  ~
  ~  Copyright (C) 2017-2018 - Noé Vázquez González,
  ~  Miguel Reboiro-Jato, Jorge Vieira, Hugo López-Fernández,
  ~  and Cristina Vieira.
  ~
  ~  This program is free software: you can redistribute it and/or modify
  ~  it under the terms of the GNU General Public License as published by
  ~  the Free Software Foundation, either version 3 of the License, or
  ~  (at your option) any later version.
  ~
  ~  This program is distributed in the hope that it will be useful,
  ~  but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~  GNU General Public License for more details.
  ~
  ~  You should have received a copy of the GNU General Public License
  ~  along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->
<mat-card *ngIf="!showForm">
  <mat-card-content>
    <button mat-raised-button color="primary" (click)="showForm = true">New query</button>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="showForm">
  <mat-card-content>
<form [formGroup]="formDistinctSpecies" (change)="onChangeForm()">
  <span *ngIf="!hideForm">
    <mat-form-field class="width-50">
      <mat-select placeholder="Reference Species" (change)="onChangeSpecies($event.value, 1)" formControlName="referenceSpecies">
        <mat-option *ngFor="let specie of referenceSpecies" [value]="specie">
          {{ specie.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="width-50 right">
      <mat-select placeholder="Reference Interactome" formControlName="referenceInteractome">
        <mat-option *ngFor="let interactome of interactomes[1]" [value]="interactome">
          {{ interactome.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="width-50">
      <mat-select placeholder="Target Species" (change)="onChangeSpecies($event.value, 2)" formControlName="targetSpecies">
        <mat-option *ngFor="let specie of targetSpecies" [value]="specie">
          {{ specie.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="width-50 right">
      <mat-select placeholder="Target Interactome" formControlName="targetInteractome">
        <mat-option *ngFor="let interactome of interactomes[2]" [value]="interactome">
          {{ interactome.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="width-100">
      <mat-label>Gene</mat-label>
      <input type="search" matInput placeholder="Start typing something to search genes"
             formControlName="gene"
             autocomplete="off"
             [value]="genesInput" />
    </mat-form-field>
    <div class="div-autocomplete">
      <mat-progress-bar mode="indeterminate" *ngIf="searchingGenes"></mat-progress-bar>
      <mat-accordion>
        <app-autocomplete *ngFor="let gene of genes" [title]="gene.geneId" [names]="gene.names" (radioSelected)="onGeneSelected($event)">
        </app-autocomplete>
      </mat-accordion>
    </div>

    <mat-form-field class="width-25">
      <input type="number" matInput placeholder="Number of descriptions (max_target_seqs)" formControlName="numDescriptions" [(ngModel)]="numDescriptions" [min]="1" [max]="100" [step]="1">
    </mat-form-field>
    <mat-slider thumbLabel tickInterval="1" [min]="1" [max]="100" [(ngModel)]="numDescriptions" formControlName="numDescriptions" class="width-75 right"></mat-slider>
    <mat-form-field class="width-25">
      <input type="number" matInput placeholder="Minimum expect value (evalue)" formControlName="eValue" [(ngModel)]="eValue" [min]="0" [max]="1" [step]="0.01">
    </mat-form-field>
    <mat-slider thumbLabel [min]="0" [max]="1" [step]="0.01" [(ngModel)]="eValue" formControlName="eValue" class="width-75 right"></mat-slider>
    <mat-form-field class="width-25">
      <input type="number" matInput placeholder="Minimum length of alignment block" formControlName="minAlignLength" [(ngModel)]="minAlignLength" [min]="0" [max]="1000" [step]="1">
    </mat-form-field>
    <mat-slider thumbLabel tickInterval="1" [min]="0" [max]="1000" [(ngModel)]="minAlignLength" formControlName="minAlignLength" class="width-75 right"></mat-slider>
    <mat-form-field class="width-25">
      <input type="number" matInput placeholder="Minimum identity (%)" formControlName="minIdentity" [(ngModel)]="minIdentity" [min]="0" [max]="100" [step]="1">
    </mat-form-field>
    <mat-slider thumbLabel tickInterval="1" [min]="0" [max]="100" [step]="1" [(ngModel)]="minIdentity" formControlName="minIdentity" class="width-75 right"></mat-slider>
    <mat-form-field class="width-25">
      <input type="number" matInput placeholder="Interaction level" formControlName="level" [(ngModel)]="level" [min]="1" [max]="3" [step]="1">
    </mat-form-field>
    <mat-slider thumbLabel tickInterval="1" [min]="1" [max]="3" [(ngModel)]="level" formControlName="level" class="width-75 right"></mat-slider>

    <button mat-raised-button button color="primary" (click)="onCompare()" [disabled]="formDistinctSpecies.status === 'INVALID' || processing">Compare</button>
  </span>
</form>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="showTable">
  <mat-card-content>
    <a mat-raised-button color="primary" [href]="csvContent" [download]="csvName" *ngIf="csvContent !== ''">Export CSV</a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/' + referenceInteractome.id + '/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export {{referenceInteractome.species.name}}-{{referenceInteractome.name}} FASTA
    </a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/' + targetInteractome.id + '/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export {{targetInteractome.species.name}}-{{targetInteractome.name}} FASTA
    </a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export Single FASTA
    </a>
    <a *ngIf="permalink" mat-raised-button color="primary" [href]="permalink" target="_blank">
      <mat-icon>link</mat-icon> Permalink to result</a>

    <mat-tab-group>
      <mat-tab label="Table view">
        <mat-table matSort [dataSource]="dataSource" class="table-distinct-species" appAfterViewInit (afterViewInit)="initTable()">
          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
          <ng-container matColumnDef="GeneA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA, row.blastResultsA)" ngClass="{{'gene' + row.typeA}}">{{row.geneA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA, row.blastResultsA)" ngClass="{{'gene' + row.typeA}}">{{row.firstNameA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="GeneB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB, row.blastResultsB)" ngClass="{{'gene' + row.typeB}}">{{row.geneB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB, row.blastResultsB)" ngClass="{{'gene' + row.typeB}}">{{row.firstNameB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="ReferenceInteractome">
            <mat-header-cell *matHeaderCellDef mat-sort-header>
              {{referenceInteractome.species.name}}
              {{referenceInteractome.name}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <div *ngIf="row.referenceDegree !== ''">Degree {{row.referenceDegree}}</div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="TargetInteractome">
            <mat-header-cell *matHeaderCellDef mat-sort-header>
              {{targetInteractome.species.name}}
              {{targetInteractome.name}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
              <div *ngFor="let degree of row.targetDegrees">Degree {{degree}}</div>
            </mat-cell>
          </ng-container>
        </mat-table>
        <mat-paginator #paginator
                       [pageSize]="10"
                       [pageSizeOptions]="[5, 10, 20, 50]">
        </mat-paginator>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length <= 100 || lastQueryMaxDegree <= 1">
        <app-graph [nodes]="nodes" [links]="links" [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-graph>
        <app-legend-distinct-species [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-legend-distinct-species>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length > 100 && lastQueryMaxDegree > 1">
        <mat-card>
          <h2>Too much genes. Interactions graph is only shown for up to 100 genes when degree is greater than one.</h2>
        </mat-card>
      </mat-tab>
    </mat-tab-group>
  </mat-card-content>
</mat-card>
