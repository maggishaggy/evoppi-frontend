<!--
  ~  EvoPPI Frontend
  ~
  ~  Copyright (C) 2017-2018 - Noé Vázquez González,
  ~  Miguel Reboiro-Jato, Jorge Vieira, Hugo López-Fernández,
  ~  and Cristina Vieira.
  ~
  ~  This program is free software: you can redistribute it and/or modify
  ~  it under the terms of the GNU General Public License as published by
  ~  the Free Software Foundation, either version 3 of the License, or
  ~  (at your option) any later version.
  ~
  ~  This program is distributed in the hope that it will be useful,
  ~  but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~  GNU General Public License for more details.
  ~
  ~  You should have received a copy of the GNU General Public License
  ~  along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->
<mat-card *ngIf="!showForm">
  <mat-card-content>
    <button mat-raised-button color="primary" (click)="showForm = true">New query</button>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="showForm">
  <mat-card-content>
    <form [formGroup]="formSameSpecies" (change)="onChangeForm()">
      <span>
        <mat-form-field class="width-100">
          <mat-select placeholder="Species" [value]="formSameSpecies.value.species" (change)="onChangeSpecies($event.value)" formControlName="species">
            <mat-option *ngFor="let specie of species" [value]="specie">
              {{ specie.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="width-100">
          <mat-select placeholder="Interactomes" formControlName="interactomes"
                      [value]="formSameSpecies.value.interactomes" [multiple]="true">
            <mat-option disabled="disabled" *ngIf="interactomes" class="filter-option">
            <button mat-raised-button color="primary"
                    (click)="selectAllInteractomes('interactomes', interactomes)">
              Select All
            </button>
            <button mat-raised-button color="accent"
                    (click)="deselectAllInteractomes('interactomes')">
              Deselect All
            </button>
        </mat-option>
            <mat-option *ngFor="let interactome of interactomes" [value]="interactome">
              {{ interactome.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="width-100">
          <mat-label>Gene</mat-label>
          <input #searchInput type="search" matInput placeholder="Start typing something to search genes"
                 formControlName="gene"
                 autocomplete="off"
                 [value]="genesInput" />
        </mat-form-field>
        <div class="div-autocomplete">
          <mat-progress-bar mode="indeterminate" *ngIf="searchingGenes"></mat-progress-bar>
          <mat-accordion>
            <app-autocomplete *ngFor="let gene of genes" [title]="gene.geneId" [names]="gene.names" (radioSelected)="onGeneSelected($event)">
            </app-autocomplete>
          </mat-accordion>
        </div>
        <mat-form-field class="width-25">
          <input type="number" matInput placeholder="Interaction level" formControlName="level" [(ngModel)]="level">
        </mat-form-field>
        <mat-slider thumbLabel tickInterval="1" [min]="1" [max]="3" [(ngModel)]="level" formControlName="level" class="width-75 right"></mat-slider>

        <mat-error *ngIf="formSameSpecies.hasError('invalidForm')">
          {{formSameSpecies.getError('invalidForm')}}
        </mat-error>
        <button mat-raised-button color="primary" (click)="onCompare()" [disabled]="formSameSpecies.status === 'INVALID' || processing">Compare</button>
      </span>
    </form>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="!showTable && paginatedDataSource.loading$ | async">
  <mat-spinner class="app-spinner"></mat-spinner>
</mat-card>
<mat-card *ngIf="showTable">
  <mat-card-content>
    <mat-menu #exportMenu="matMenu">
      <a mat-menu-item [href]="resultUrl + '/interactome/fasta'" target="_blank">
        Single FASTA
      </a>
      <a mat-menu-item *ngFor="let resInteractome of resInteractomes" [href]="resultUrl + '/interactome/' + resInteractome.id + '/fasta'"
         target="_blank">
        {{resInteractome.name}}
      </a>
    </mat-menu>
    <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenu">
      <mat-icon>more_vert</mat-icon> Export FASTA
    </button>
    <button mat-raised-button color="primary" *ngIf="csvContent === '' && !processing" (click)="onPrepareCSV()">Prepare CSV export</button>
    <button mat-raised-button color="primary" *ngIf="csvContent === '' && processing">
      Preparing CSV...
    </button>
    <button mat-button *ngIf="csvContent === '' && processing" disabled>
      <mat-icon><mat-spinner [diameter]="20" color="accent"></mat-spinner></mat-icon>
    </button>
    <a mat-raised-button color="primary" [href]="csvContent" [download]="csvName" *ngIf="csvContent !== ''">Export CSV</a>

    <a *ngIf="permalink" mat-raised-button color="primary" [href]="permalink" target="_blank">
        <mat-icon>link</mat-icon> Permalink to result</a>

    <mat-checkbox (change)="onCollapseInteractomes($event)" class="app-checkbox">Collapse interactomes</mat-checkbox>

    <mat-tab-group (selectedTabChange)="onChangeTab($event)">
      <mat-tab label="Table view">
        <mat-table matSort #table [dataSource]="paginatedDataSource" class="table-same-species" appAfterViewInit>
          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
          <ng-container matColumnDef="GeneA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA)" class="gene1">{{row.geneA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA)" class="gene1">{{row.firstNameA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="GeneB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB)" class="gene1">{{row.geneB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB)" class="gene1">{{row.firstNameB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container *ngFor="let resInteractome of resInteractomes" matColumnDef="Interactome-{{resInteractome.id}}">
            <mat-header-cell *matHeaderCellDef mat-sort-header>{{resInteractome.name}}</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <span *ngFor="let degree of row.interactomeDegrees">
                <span *ngIf="degree.id === resInteractome.id">
                  Degree {{degree.degree}}
                </span>
              </span>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="Interactomes">
            <mat-header-cell *matHeaderCellDef>Interactomes</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <div *ngIf="row.interactomeDegrees.length === 1">
                Degree
                <span *ngFor="let degree of row.interactomeDegrees">
                  {{degree.degree}}
                </span>
              </div>
              <div *ngIf="row.interactomeDegrees.length > 1">
                Degrees:
                <span *ngFor="let degree of row.interactomeDegrees; let isLast=last">
                  {{degree.degree}}{{isLast ? '': ','}}
                </span>
              </div>
            </mat-cell>
          </ng-container>
        </mat-table>
        <mat-paginator #paginator appAfterViewInit (afterViewInit)="initPaginator()"
                       [pageSize]="10"
                       [pageSizeOptions]="[5, 10, 20, 50]"
                       [length]="paginatorLength">
        </mat-paginator>
        <app-legend-table></app-legend-table>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length <= 100 || lastQueryMaxDegree <= 1">
        <mat-card *ngIf="processing && !fullResultAvailable">
          <mat-spinner class="app-spinner"></mat-spinner>
        </mat-card>
        <app-graph *ngIf="fullResultAvailable" [nodes]="nodes" [links]="links" [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-graph>
        <app-legend-same-species *ngIf="fullResultAvailable" [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-legend-same-species>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length > 100 && lastQueryMaxDegree > 1">
        <mat-card>
          <h2>Too much genes. Interactions graph is only shown for up to 100 genes when degree is greater than one.</h2>
        </mat-card>
      </mat-tab>
    </mat-tab-group>
  </mat-card-content>
</mat-card>
